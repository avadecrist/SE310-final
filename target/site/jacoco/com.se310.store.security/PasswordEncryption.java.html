<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordEncryption.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">final</a> &gt; <a href="index.source.html" class="el_package">com.se310.store.security</a> &gt; <span class="el_source">PasswordEncryption.java</span></div><h1>PasswordEncryption.java</h1><pre class="source lang-java linenums">package com.se310.store.security;

import com.se310.store.config.ConfigLoader;

import javax.crypto.Cipher;
import javax.crypto.spec.SecretKeySpec;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.util.Arrays;
import java.util.Base64;

/**
 * PasswordEncryption - Utility class for encrypting and decrypting passwords using AES encryption.
 *
 * This class demonstrates security best practices:
 * - Passwords are never stored in plain text
 * - Encryption key is externalized in configuration
 * - Uses industry-standard AES encryption
 * - Provides both encryption and verification methods
 *
 * @author  Sergey L. Sundukovskiy
 * @version 1.0
 * @since   2025-11-13
 */
public class PasswordEncryption {

    private static final String ALGORITHM = &quot;AES&quot;;
    private static SecretKeySpec secretKey;

    // Private constructor to prevent instantiation
<span class="nc" id="L31">    private PasswordEncryption() {</span>
<span class="nc" id="L32">        throw new UnsupportedOperationException(&quot;Utility class cannot be instantiated&quot;);</span>
    }

    /**
     * Initialize the secret key from the encryption key in configuration
     *
     * @param encryptionKey The encryption key from application.properties
     */
    private static void setKey(String encryptionKey) {
        try {
<span class="nc" id="L42">            byte[] key = encryptionKey.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L43">            MessageDigest sha = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
<span class="nc" id="L44">            key = sha.digest(key);</span>
<span class="nc" id="L45">            key = Arrays.copyOf(key, 16); // Use only first 128 bits (16 bytes) for AES-128</span>
<span class="nc" id="L46">            secretKey = new SecretKeySpec(key, ALGORITHM);</span>
<span class="nc" id="L47">        } catch (Exception e) {</span>
<span class="nc" id="L48">            throw new RuntimeException(&quot;Error initializing encryption key&quot;, e);</span>
        }
<span class="nc" id="L50">    }</span>

    /**
     * Encrypt a password using AES encryption
     *
     * @param password The plain text password to encrypt
     * @return The encrypted password as a Base64-encoded string
     */
    public static String encrypt(String password) {
        try {
<span class="nc" id="L60">            setKey(ConfigLoader.getEncryptionKey());</span>
<span class="nc" id="L61">            Cipher cipher = Cipher.getInstance(ALGORITHM);</span>
<span class="nc" id="L62">            cipher.init(Cipher.ENCRYPT_MODE, secretKey);</span>
<span class="nc" id="L63">            byte[] encrypted = cipher.doFinal(password.getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L64">            return Base64.getEncoder().encodeToString(encrypted);</span>
<span class="nc" id="L65">        } catch (Exception e) {</span>
<span class="nc" id="L66">            throw new RuntimeException(&quot;Error encrypting password&quot;, e);</span>
        }
    }

    /**
     * Decrypt an encrypted password
     *
     * @param encryptedPassword The encrypted password as a Base64-encoded string
     * @return The decrypted plain text password
     */
    public static String decrypt(String encryptedPassword) {
        try {
<span class="nc" id="L78">            setKey(ConfigLoader.getEncryptionKey());</span>
<span class="nc" id="L79">            Cipher cipher = Cipher.getInstance(ALGORITHM);</span>
<span class="nc" id="L80">            cipher.init(Cipher.DECRYPT_MODE, secretKey);</span>
<span class="nc" id="L81">            byte[] decrypted = cipher.doFinal(Base64.getDecoder().decode(encryptedPassword));</span>
<span class="nc" id="L82">            return new String(decrypted, StandardCharsets.UTF_8);</span>
<span class="nc" id="L83">        } catch (Exception e) {</span>
<span class="nc" id="L84">            throw new RuntimeException(&quot;Error decrypting password&quot;, e);</span>
        }
    }

    /**
     * Verify if a plain text password matches an encrypted password
     *
     * @param plainPassword The plain text password to verify
     * @param encryptedPassword The encrypted password to compare against
     * @return true if the passwords match, false otherwise
     */
    public static boolean verify(String plainPassword, String encryptedPassword) {
        try {
<span class="nc" id="L97">            String decrypted = decrypt(encryptedPassword);</span>
<span class="nc" id="L98">            return plainPassword.equals(decrypted);</span>
<span class="nc" id="L99">        } catch (Exception e) {</span>
            // If decryption fails, passwords don't match
<span class="nc" id="L101">            return false;</span>
        }
    }

    /**
     * Check if a password is already encrypted
     * This is a simple heuristic - encrypted passwords are Base64-encoded and typically longer
     *
     * @param password The password to check
     * @return true if the password appears to be encrypted, false otherwise
     */
    public static boolean isEncrypted(String password) {
<span class="nc bnc" id="L113" title="All 4 branches missed.">        if (password == null || password.isEmpty()) {</span>
<span class="nc" id="L114">            return false;</span>
        }

        // Encrypted passwords are Base64-encoded and typically longer than plain text
        // Also check if it's valid Base64
        try {
<span class="nc" id="L120">            Base64.getDecoder().decode(password);</span>
            // If it decodes successfully and is reasonably long, it's likely encrypted
<span class="nc bnc" id="L122" title="All 2 branches missed.">            return password.length() &gt; 20;</span>
<span class="nc" id="L123">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L124">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>